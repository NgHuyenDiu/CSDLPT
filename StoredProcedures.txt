CREATE PROC [dbo].[sp_indanhsachvattu]
AS
BEGIN
	SELECT MAVT as 'Mã vật tư', TENVT as 'Tên vật tư', DVT as 'Đơn vị tính'
	FROM Vattu
	ORDER BY TENVT ASC
END

GO

***********************************
CREATE procedure  [dbo].[sp_checknhanviencologin]
@TENLOGIN NVARCHAR(50)
AS
BEGIN
SELECT MANV, HOTEN= HO +''+TEN 
FROM NHANVIEN
WHERE CONVERT(VARCHAR, MANV) IN (SELECT NAME FROM SYS.SYSUSERS)AND TRANGTHAIXOA=0 AND MANV= @TENLOGIN
END

***************************************
CREATE PROCEDURE [dbo].[sp_checkquyenxoanhanvien] 
@TENLOGIN VARCHAR(50),	--TENLOGIN LÀ TRUYỀN MÃ NHÂN VIÊN VÔ
@ROLENGUOIXOA VARCHAR(50)
AS
BEGIN
DECLARE @SID VARBINARY(85)
	SELECT @SID = SID FROM SYS.SYSUSERS WHERE NAME = @TENLOGIN
	IF (@SID IS NOT NULL)
	BEGIN
		DECLARE @LGNAME VARCHAR(50)
		SELECT @LGNAME = LOGINNAME FROM SYS.SYSLOGINS WHERE SID = @SID
	END
DECLARE @TENUSER NVARCHAR(50), @USERID INT, @ROLE NVARCHAR(50)
	
	SELECT @USERID= UID ,@TENUSER=NAME FROM SYS.SYSUSERS WHERE SID = SUSER_SID(@LGNAME)
IF EXISTS(SELECT HO+ ' '+ TEN FROM DBO.NHANVIEN WHERE MANV = @TENUSER AND TRANGTHAIXOA=0)
BEGIN
	SELECT 
   @ROLE = NAME
   FROM SYS.SYSUSERS 
   WHERE UID = (SELECT GROUPUID 
                 FROM SYS.SYSMEMBERS 
                   WHERE MEMBERUID= @USERID
               )

END
IF((@ROLENGUOIXOA = 'CHINHANH' AND @ROLE = 'CONGTY')OR(@ROLENGUOIXOA = 'USER' AND @ROLE = 'CONGTY') OR(@ROLENGUOIXOA = 'USER' AND @ROLE = 'CHINHANH'))
RAISERROR('BẠN KHÔNG ĐỦ QUYỀN ĐỂ XÓA NHÂN VIÊN NÀY',16,1)
END

*****************************************
CREATE PROCEDURE [dbo].[sp_chuyenchinhanh] @MANV INT,
@MAMOI INT
AS

SET XACT_ABORT ON;
BEGIN TRY
BEGIN DISTRIBUTED TRANSACTION;
	DECLARE @TTX INT
	SELECT @TTX=TRANGTHAIXOA FROM NHANVIEN WHERE MANV = @MANV
	IF(@TTX=0)
		BEGIN
			DECLARE @MACN NCHAR(10)
			SELECT @MACN = MACN FROM LINK1.QLVT_DATHANG.DBO.CHINHANH

			-- KIEM TRA NHAN VIEN DA TON TAI O CHI NHANH CON LAI CHUA
			DECLARE @HO NVARCHAR(50), @TEN NVARCHAR(50) , @NGAYSINH NVARCHAR(50), @DIACHI NVARCHAR(50)
			SELECT @HO= HO, @TEN=TEN, @DIACHI=DIACHI,@NGAYSINH= NGAYSINH FROM NHANVIEN WHERE MANV=@MANV
			SELECT @@ROWCOUNT FROM LINK1.QLVT_DATHANG.DBO.NHANVIEN 
					WHERE (HO= @HO AND TEN= @TEN AND DIACHI= @DIACHI AND NGAYSINH= @NGAYSINH)

			IF(@@ROWCOUNT = 1 )-- NEU NHAN VIEN DA TON TAI Ở CHI NHANH CON LAI
				BEGIN
					UPDATE LINK1.QLVT_DATHANG.DBO.NHANVIEN SET TRANGTHAIXOA = 0
					WHERE HO = @HO AND TEN = @TEN AND NGAYSINH= @NGAYSINH AND DIACHI= @DIACHI
				END
			ELSE
				BEGIN
					INSERT INTO LINK1.QLVT_DATHANG.DBO.NHANVIEN (MANV, HO, TEN, DIACHI, NGAYSINH, LUONG, MACN, TRANGTHAIXOA)
					SELECT MANV=@MAMOI,HO,TEN,DIACHI,NGAYSINH,LUONG,MACN=@MACN,TRANGTHAIXOA = 0
					FROM NHANVIEN
					WHERE MANV = @MANV
				END
				-- CẬP NHẬP TRẠNG THÁI XOÁ CỦA NHÂN VIÊN HIỆN TẠI
			UPDATE NHANVIEN SET TRANGTHAIXOA = 1
			WHERE MANV = @MANV
		END
	ELSE
		RAISERROR(50001, 18, 1, N'NHÂN VIÊN ĐÃ CHUYỂN CHI NHÁNH')
COMMIT TRANSACTION;

END TRY
-- bắt trường hợp nếu đã có trasaction mở rồi mà mở thêm
BEGIN CATCH
	--@@TRANCOUNT trả về số lượng transaction đang hoạt động
	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRAN;
	END;
	THROW;
END CATCH

*********************************************
CREATE PROC [dbo].[SP_DANGNHAP]
@TENLOGIN NVARCHAR (50)
AS
DECLARE @TENUSER NVARCHAR(50)
SELECT @TENUSER=NAME FROM sys.sysusers WHERE sid = SUSER_SID(@TENLOGIN)
 
 SELECT USERNAME = @TENUSER, 
  HOTEN = (SELECT HO+ ' '+ TEN FROM NHANVIEN  WHERE MANV = @TENUSER ),
   TENNHOM= NAME
   FROM sys.sysusers 
   WHERE UID = (SELECT GROUPUID 
                 FROM SYS.SYSMEMBERS 
                   WHERE MEMBERUID= (SELECT UID FROM sys.sysusers 
                                      WHERE NAME=@TENUSER))

********************************************
CREATE proc [dbo].[sp_ktrasoluongvattu]
@MAPHIEU NCHAR(8),
@MAVT NCHAR(4),
@SOLUONG INT
AS
BEGIN
IF(@SOLUONG<=(SELECT SOLUONG FROM CTDDH WHERE MASODDH= @MAPHIEU AND MAVT= @MAVT))
		SELECT SOLUONG FROM CTDDH WHERE MASODDH= @MAPHIEU AND MAVT= @MAVT
ELSE
	RAISERROR(N'SỐ LƯỢNG VẬT TƯ KHÔNG HỢP LỆ !',16,1)
END

********************************************
CREATE PROCEDURE [dbo].[sp_layloginname] @tenlogin VARCHAR(50)	--tenlogin là truyền mã nhân viên
AS
BEGIN
	DECLARE @SID VARBINARY(85)
	SELECT @SID = sid FROM sys.sysusers WHERE name = @tenlogin
	IF (@SID IS NULL)
		RAISERROR('K TIM THAY SID',16,1)
	ELSE
	BEGIN
		DECLARE @LGNAME VARCHAR(50)
		SELECT @LGNAME = loginname FROM sys.syslogins WHERE sid = @SID
		IF(@LGNAME IS NULL)
			RAISERROR('K TIM THAY LGNAME',16,1)
		ELSE
			select @LGNAME
	END
END
**************************************
CREATE proc [dbo].[sp_layquyennhanvien]
@TENLOGIN VARCHAR(50)
AS
BEGIN
DECLARE @USERID INT, @ROLE NVARCHAR(50) 
	SELECT @USERID = UID FROM SYS.SYSUSERS WHERE NAME = @TENLOGIN
IF EXISTS(SELECT HO+ ' '+ TEN FROM DBO.NHANVIEN WHERE MANV = @TENLOGIN AND TRANGTHAIXOA=0)
BEGIN
	SELECT 
   @ROLE = NAME
   FROM SYS.SYSUSERS 
   WHERE UID = (SELECT GROUPUID 
                 FROM SYS.SYSMEMBERS 
                   WHERE MEMBERUID= @USERID
               )
IF(@ROLE IS NOT NULL)
	BEGIN
	SELECT @ROLE
	END
ELSE
	RAISERROR('KHONG CO QUYEN HAN',16,1)
END
END
****************************
CREATE PROC [dbo].[sp_timctddh]
@MADDH NCHAR(8),
@MAVT NCHAR(4)
AS
BEGIN
	IF EXISTS (SELECT * FROM DBO.CTDDH WHERE MASODDH = @MADDH AND MAVT = @MAVT)
		RETURN 1;
	ELSE
		IF EXISTS (SELECT * FROM LINK1.QLVT_DATHANG.DBO.CTDDH WHERE MASODDH = @MADDH AND MAVT = @MAVT)
			RETURN 1;
		ELSE
			RAISERROR(N'CHI TIẾT ĐƠN ĐẶT HÀNG BẠN TÌM KHÔNG TỒN TẠI',16,1)
END
*************************************
CREATE PROC [dbo].[sp_timddh]
@MADDH NCHAR(8)
AS
BEGIN
	IF EXISTS (SELECT MaSoDDH FROM DBO.DATHANG WHERE MASODDH = @MADDH)
		RETURN 1;
	ELSE
		IF EXISTS (SELECT MasoDDH FROM LINK1.QLVT_DATHANG.DBO.DATHANG WHERE MASODDH = @MADDH)
			RETURN 1;
		ELSE
			RAISERROR(N'ĐƠN ĐẶT HÀNG BẠN TÌM KHÔNG TỒN TẠI',16,1)
END
**************************************
CREATE PROC [dbo].[sp_timkho]
@MAKHO NCHAR(4)
AS
BEGIN
	IF EXISTS (SELECT MAKHO FROM DBO.KHO WHERE MAKHO = @MAKHO)
		RETURN 1;
	ELSE
		IF EXISTS (SELECT MAKHO FROM LINK1.QLVT_DATHANG.DBO.KHO WHERE MAKHO = @MAKHO)
			RETURN 1;
		ELSE
			RAISERROR(N'KHO BẠN TÌM KHÔNG TỒN TẠI',16,1)
END
*************************************
CREATE proc [dbo].[sp_timphieunhap]
@MAPN NCHAR(8)
AS
BEGIN
	IF EXISTS (SELECT MAPN FROM DBO.PHIEUNHAP WHERE MAPN = @MAPN)
		RETURN 1;
	ELSE
		IF EXISTS (SELECT MAPN FROM LINK1.QLVT_DATHANG.DBO.PHIEUNHAP WHERE MAPN = @MAPN)
			RETURN 1;
		ELSE
			RAISERROR(N'PHIẾU NHẬP BẠN TÌM KHÔNG TỒN TẠI',16,1)
END
************************************
CREATE PROC [dbo].[sp_timphieuxuat]
@MAPX NCHAR(8)
AS
BEGIN
IF EXISTS (SELECT MAPX FROM DBO.PHIEUXUAT WHERE MAPX = @MAPX)
		RETURN 1;
	ELSE
		IF EXISTS (SELECT MAPX FROM LINK1.QLVT_DATHANG.DBO.PHIEUXUAT WHERE MAPX = @MAPX)
			RETURN 1;
		ELSE
			RAISERROR(N'PHIEU XUAT BẠN TÌM KHÔNG TỒN TẠI',16,1) 
END
********************************
CREATE PROCEDURE [dbo].[sp_undochuyencn] @MANV INT,
@MAMOI INT
AS
SET XACT_ABORT ON 
BEGIN TRANSACTION
BEGIN TRY
	UPDATE NHANVIEN SET TRANGTHAIXOA = 0 WHERE MANV = @MANV
	DELETE LINK1.QLVT_DATHANG.DBO.NHANVIEN WHERE MANV = @MAMOI
	COMMIT
END TRY
BEGIN CATCH
   ROLLBACK
	DECLARE @ErrorMessage VARCHAR(2000)
	SELECT @ErrorMessage = 'Lỗi: ' + ERROR_MESSAGE()
	RAISERROR( @ErrorMessage, 16, 1)
END CATCH
***********************************
CREATE  PROCEDURE [dbo].[sp_undoxoanhanvien] 
	@LGNAME VARCHAR(50),
	@USERNAME VARCHAR(50),
	@HO NVARCHAR(50),
	@TEN NVARCHAR(50),
	@DIACHI NVARCHAR(50),
	@NGAYSINH VARCHAR(50),
	@LUONG VARCHAR(50),
	@MACN VARCHAR(50),
	@ROLE NVARCHAR(50)
AS
BEGIN
	INSERT INTO NHANVIEN (MANV, HO, TEN, DIACHI, NGAYSINH, LUONG, MACN, TRANGTHAIXOA) VALUES (@USERNAME,@HO,@TEN,@DIACHI,@NGAYSINH,@LUONG,@MACN,0)


	DECLARE @RET INT
		EXEC @RET = SP_ADDLOGIN @LGNAME, '123456', 'QLVT_DATHANG'
			IF (@RET =1) --LOGINNAME BI TRUNG
				RETURN 1
		EXEC @RET = SP_GRANTDBACCESS @LGNAME, @USERNAME
		IF(@RET =1) --USER NAME BI TRUNG
		BEGIN
			EXEC SP_DROPLOGIN @LGNAME
			RETURN 2
		END
		EXEC SP_ADDROLEMEMBER  @ROLENAME =  @ROLE,  @MEMBERNAME =  @USERNAME
		IF @ROLE='CONGTY' OR @ROLE='CHINHANH'
			EXEC SP_ADDSRVROLEMEMBER @LGNAME, 'SECURITYADMIN'
			RETURN 0 -- THANH CONG
		COMMIT
		RETURN 0 -- THANH CONG

	

END
**********************************************
CREATE PROCEDURE [dbo].[sp_xoatkdangnhap] 
@TENLOGIN VARCHAR(50)	--TENLOGIN LÀ TRUYỀN MÃ NHÂN VIÊN VÔ
AS
BEGIN
	DECLARE @SID VARBINARY(85)
	SELECT @SID = SID FROM SYS.SYSUSERS WHERE NAME = @TENLOGIN
	IF (@SID IS NULL)
		RAISERROR('NHÂN VIÊN CHƯA TẠO TÀI KHOẢN',16,1)
	ELSE
	BEGIN
		DECLARE @LGNAME VARCHAR(50)
		SELECT @LGNAME = LOGINNAME FROM SYS.SYSLOGINS WHERE SID = @SID
		IF(@LGNAME IS NOT NULL)
		BEGIN
			EXEC SP_DROPUSER @TENLOGIN	--XÓA USER TRONG SERVER ROLE
			EXEC SP_DROPLOGIN @LGNAME	--XÓA TÀI KHOẢN ĐĂNG NHẬP CỦA NHÂN VIÊN
		END
		ELSE
			RAISERROR('NHÂN VIÊN CHƯA TẠO TÀI KHOẢN',16,1)
	END
END
*******************************************
CREATE proc [dbo].[sp_capnhatsoluongton]
@MAVT NCHAR(4), 
@SOLUONG INT,
@LOAI CHAR(1)
AS
BEGIN
DECLARE  @SL INT	
IF EXISTS (SELECT  MAVT FROM VATTU WHERE MAVT= @MAVT)
BEGIN
	SELECT @SL= SOLUONGTON FROM VATTU WHERE MAVT= @MAVT
	IF @LOAI ='N'
		BEGIN
		UPDATE VATTU SET SOLUONGTON = @SL+ @SOLUONG WHERE MAVT= @MAVT
		END
	ELSE 
		BEGIN
		IF @SL - @SOLUONG >=0
		UPDATE VATTU SET SOLUONGTON = @SL - @SOLUONG WHERE MAVT= @MAVT
		ELSE
		RAISERROR(N'SO LUONG VAT TU KHONG DU',16,1)
		END
END
ELSE
    RAISERROR(N'VAT TU KHONG TON TAI',16,1)
END	
*********************************************
CREATE PROC [dbo].[sp_phieunvlaptrongnamtheoloai]
@MANV INT, @LOAI CHAR, @NAM INT
AS
BEGIN
IF  @LOAI='N'
	SELECT PS.PHIEU, NGAY, TENVT, SOLUONG,DONGIA
	FROM (SELECT MAPN AS PHIEU ,NGAY FROM PHIEUNHAP
			WHERE MANV= @MANV AND YEAR(NGAY)= @NAM) PS, CTPN CT, VATTU VT
	WHERE PS.PHIEU= CT.MAPN AND CT.MAVT= VT.MAVT
	ORDER BY NGAY, PS.PHIEU
ELSE
	SELECT PS.PHIEU, NGAY, TENVT, SOLUONG,DONGIA
	FROM (SELECT MAPX AS PHIEU ,NGAY FROM PHIEUXUAT
			WHERE MANV= @MANV AND YEAR(NGAY)= @NAM) PS, CTPX CT, VATTU VT
	WHERE PS.PHIEU= CT.MAPX AND CT.MAVT= VT.MAVT
	ORDER BY NGAY, PS.PHIEU
 END
*******************************************
CREATE PROCEDURE [dbo].[sp_undothemCTPN] @MAPN nchar(8), @MAVT NCHAR(4), @SOLUONG INT ,@LOAI CHAR(1)
AS
SET XACT_ABORT ON 
BEGIN TRANSACTION
BEGIN TRY
	delete from CTPN where MAPN= @MAPN AND MAVT= @MAVT
	EXEC sp_capnhatsoluongton @MAVT, @SOlUONG, @LOAI
COMMIT TRANSACTION
END TRY
BEGIN CATCH
   ROLLBACK
	DECLARE @ErrorMessage VARCHAR(2000)
	SELECT @ErrorMessage = 'Lỗi: ' + ERROR_MESSAGE()
	RAISERROR( @ErrorMessage, 16, 1)
END CATCH
*********************************************
CREATE PROC [dbo].[sp_undoxoaCTPN]
@MAPN nchar(8), @MAVT NCHAR(4), @SOLUONG INT , @DONGIA FLOAT,@LOAI CHAR(1)
AS
SET XACT_ABORT ON 
BEGIN TRANSACTION
BEGIN TRY
	Insert into CTPN (MAPN, MAVT, SOLUONG, DONGIA) values(@MAPN, @MAVT, @SOLUONG , @DONGIA )	
	EXEC sp_capnhatsoluongton @MAVT, @SOlUONG, @LOAI
COMMIT TRANSACTION
END TRY
BEGIN CATCH
   ROLLBACK
	DECLARE @ErrorMessage VARCHAR(2000)
	SELECT @ErrorMessage = 'Lỗi: ' + ERROR_MESSAGE()
	RAISERROR( @ErrorMessage, 16, 1)
END CATCH
************************************************
CREATE PROCEDURE [dbo].[SP_TAOTAIKHOAN] @LGNAME VARCHAR(50),
	@PASS VARCHAR(50),
	@USERNAME VARCHAR(50),
	@ROLE VARCHAR(50)
AS
BEGIN
	DECLARE @RET INT
		EXEC @RET = sp_addlogin @LGNAME, @PASS, 'QLVT_DATHANG'
			IF (@RET =1) --LOGINNAME BI TRUNG
				RETURN 1
		EXEC @RET = sp_grantdbaccess @LGNAME, @USERNAME
		IF(@RET =1) --USER NAME BI TRUNG
		BEGIN
			EXEC sp_droplogin @LGNAME
			RETURN 2
		END
		EXEC sp_addrolemember @ROLE, @USERNAME
		IF @ROLE='CONGTY' OR @ROLE='CHINHANH'
			EXEC sp_addsrvrolemember @LGNAME, 'securityAdmin'
			RETURN 0 -- THANH CONG
		COMMIT
		RETURN 0 -- THANH CONG
END
****************************************
CREATE PROC [dbo].[sp_kiemtratontailogin]
@TENLOGIN NVARCHAR(50)
AS
BEGIN
SELECT NAME FROM SYS.SYSLOGINS WHERE NAME= @TENLOGIN
END
***********************************

CREATEPROC [dbo].[sp_undothemCTPX]
@MAPX nchar(8), @MAVT NCHAR(4), @SOLUONG INT ,@LOAI CHAR(1)
AS
SET XACT_ABORT ON 
BEGIN TRANSACTION
BEGIN TRY
	delete from CTPX where MAPX= @MAPX AND MAVT= @MAVT
	EXEC sp_capnhatsoluongton @MAVT, @SOlUONG, @LOAI
COMMIT TRANSACTION
END TRY
BEGIN CATCH
   ROLLBACK
	DECLARE @ErrorMessage VARCHAR(2000)
	SELECT @ErrorMessage = 'Lỗi: ' + ERROR_MESSAGE()
	RAISERROR( @ErrorMessage, 16, 1)
END CATCH
**************************
CREATEPROC [dbo].[sp_undoxoaCTPX]
@MAPX nchar(8), @MAVT NCHAR(4), @SOLUONG INT , @DONGIA FLOAT,@LOAI CHAR(1)
AS
SET XACT_ABORT ON 
BEGIN TRANSACTION
BEGIN TRY
	Insert into CTPX (MAPX, MAVT, SOLUONG, DONGIA) values(@MAPX, @MAVT, @SOLUONG , @DONGIA )	
	EXEC sp_capnhatsoluongton @MAVT, @SOlUONG, @LOAI
COMMIT TRANSACTION
END TRY
BEGIN CATCH
   ROLLBACK
	DECLARE @ErrorMessage VARCHAR(2000)
	SELECT @ErrorMessage = 'Lỗi: ' + ERROR_MESSAGE()
	RAISERROR( @ErrorMessage, 16, 1)
END CATCH
**********************************************
CREATE PROCEDURE [dbo].[sp_bangkectvt]
@MODE NCHAR,
@LOAI NCHAR,
@BEGIN NCHAR(10),
@END NCHAR(10)
AS
BEGIN
  IF @MODE = 'C'
    IF @LOAI = 'N'
    SELECT SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),4,7) AS [THOIGIAN], VT.TENVT, SUM(CT.SOLUONG) AS 'SOLUONG', SUM(CT.SOLUONG * CT.DONGIA) AS 'TRIGIA'
    FROM 
    (
      SELECT MAPN, NGAY
      FROM dbo.PhieuNhap
      WHERE NGAY BETWEEN @BEGIN and  @END
    ) PN
    INNER JOIN dbo.CTPN CT ON CT.MAPN = PN.MAPN
    INNER JOIN dbo.Vattu VT ON VT.MAVT = CT.MAVT
    GROUP BY SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),4,7), VT.TENVT -- 103	 dd/mm/yyyy
	ORDER BY SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),4,7)
    ELSE
    IF @LOAI = 'X'
      SELECT SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),4,7) AS [THOIGIAN], VT.TENVT, SUM(CT.SOLUONG) AS 'SOLUONG', SUM(CT.SOLUONG * CT.DONGIA) AS 'TRIGIA'
      FROM 
      (
      SELECT MAPX, NGAY
      FROM dbo.PhieuXuat
      WHERE NGAY BETWEEN @BEGIN and  @END
      ) PX
      INNER JOIN dbo.CTPX CT ON CT.MAPX = PX.MAPX
      INNER JOIN dbo.Vattu VT ON VT.MAVT = CT.MAVT
      GROUP BY SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),4,7), VT.TENVT
	  ORDER BY SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),4,7)
  IF @MODE = 'F'	--quyền công ty
    IF @LOAI = 'N'
    SELECT SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),4,7) AS [THOIGIAN], VT.TENVT, SUM(CT.SOLUONG) AS 'SOLUONG', SUM(CT.SOLUONG * CT.DONGIA) AS 'TRIGIA'
    FROM 
    (
      SELECT MAPN, NGAY
      FROM LINK0.QLVT_DATHANG.dbo.PhieuNhap
      WHERE NGAY BETWEEN @BEGIN and  @END
    ) PN
    INNER JOIN LINK0.QLVT_DATHANG.dbo.CTPN CT ON CT.MAPN = PN.MAPN
    INNER JOIN dbo.Vattu VT ON VT.MAVT = CT.MAVT
    GROUP BY SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),4,7), VT.TENVT
	ORDER BY SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),4,7)
    ELSE
    IF @LOAI = 'X'
      SELECT SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),4,7) AS [THOIGIAN], VT.TENVT, SUM(CT.SOLUONG) AS 'SOLUONG', SUM(CT.SOLUONG * CT.DONGIA) AS 'TRIGIA'
      FROM 
      (
      SELECT MAPX, NGAY
      FROM LINK0.QLVT_DATHANG.dbo.PhieuXuat
      WHERE NGAY BETWEEN @BEGIN and  @END
      ) PX
      INNER JOIN LINK0.QLVT_DATHANG.dbo.CTPX CT ON CT.MAPX = PX.MAPX
      INNER JOIN dbo.Vattu VT ON VT.MAVT = CT.MAVT
      GROUP BY  SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),4,7), VT.TENVT
	  ORDER BY SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),4,7)
END
GO
*************************************
CREATE PROCEDURE [dbo].[sp_dsddhchuacophieunhap]
 AS
BEGIN
  SELECT DH.MasoDDH AS 'Mã số DDH', DH.NGAY AS 'Ngày Đặt', DH.NhaCC AS 'Nhà Cung Cấp',
      NV.HO + ' ' + NV.TEN AS 'Họ và Tên', VT.TENVT AS 'Tên vật tư', CT.SOLUONG as 'Số lượng', CT.DONGIA as 'Đơn giá'
  FROM
  (
    SELECT * FROM DatHang
  ) DH
  LEFT JOIN DBO.PhieuNhap PN ON PN.MasoDDH = DH.MasoDDH
  INNER JOIN DBO.NhanVien NV ON NV.MANV = DH.MANV
  INNER JOIN DBO.CTDDH CT ON DH.MasoDDH = CT.MasoDDH
  INNER JOIN DBO.Vattu VT ON CT.MAVT = VT.MAVT
  WHERE PN.MAPN IS NULL
END
//********************************************
CREATE PROCEDURE [dbo].[sp_hdnv]
@MANV INT,
@BEGIN NCHAR(10),
@END NCHAR(10)
AS
BEGIN
SET NOCOUNT ON;
	IF 1=0 BEGIN
	SET FMTONLY OFF
END

  -- PHIEU NHAP
    SELECT FORMAT(PN.NGAY,'MM/yyyy') AS THANGNAM,
		SUBSTRING(CONVERT(VARCHAR, PN.NGAY, 103),0,11) AS NGAY,
		PN.MAPN , PN.HOTENKH , VT.TENVT , 
		TENKHO ,SOLUONG ,
		DONGIA , SOLUONG * DONGIA AS TRIGIA,
		MANV , HOTENNV  into #phieuNhap
	FROM (
			SELECT MAPN, NGAY, HOTENKH = '',
			TENKHO = (SELECT TENKHO FROM KHO WHERE KHO.MAKHO = PNP.MAKHO),
			NV.MANV, HO+ ' '+TEN AS HOTENNV  
			FROM DBO.PHIEUNHAP AS PNP ,NHANVIEN AS NV
			WHERE NV.MANV = @MANV AND  PNP.MANV= NV.MANV AND NGAY BETWEEN @BEGIN AND @END 
		 ) PN, CTPN,(SELECT TENVT, MAVT FROM VATTU) VT
	WHERE VT.MAVT = CTPN.MAVT AND CTPN.MAPN = PN.MAPN 
	ORDER BY THANGNAM, NGAY

	-- PHIEU XUAT
      SELECT FORMAT(PX.NGAY,'MM/yyyy') AS THANGNAM,
	    SUBSTRING(CONVERT(VARCHAR, PX.NGAY, 103),0,11) AS NGAY ,
		PX.MAPX , HOTENKH , VT.TENVT , 
		TENKHO ,SOLUONG ,
		DONGIA , SOLUONG * DONGIA AS TRIGIA,
		MANV , HOTENNV into #phieuXuat
		FROM (
			SELECT MAPX, NGAY, HOTENKH,
			TENKHO = (SELECT TENKHO FROM KHO WHERE KHO.MAKHO = PXP.MAKHO),
			NV.MANV, HO+ ' '+TEN AS HOTENNV  
			FROM DBO.PHIEUXUAT AS PXP ,NHANVIEN AS NV
			WHERE NV.MANV = @MANV AND  PXP.MANV= NV.MANV AND NGAY BETWEEN @BEGIN AND @END 
		 ) PX, CTPX,(SELECT TENVT, MAVT FROM VATTU) VT
	WHERE VT.MAVT = CTPX.MAVT AND CTPX.MAPX = PX.MAPX
	ORDER BY THANGNAM, NGAY

-- GOP
	SELECT N.THANGNAM ,  N.NGAY, N.MAPN , N.HOTENKH, N.TENVT  , N.TENKHO , N.SOLUONG , N.DONGIA  ,N.TRIGIA , N.MANV , N.HOTENNV 
	FROM #phieuNhap N
	UNION
	SELECT X.THANGNAM ,X.NGAY, X.MAPX, X.HOTENKH , X.TENVT  , X.TENKHO , X.SOLUONG  , X.DONGIA  , X.TRIGIA , X.MANV, X.HOTENNV 
	FROM #phieuXuat X
END
//*******************************************
CREATE proc [dbo].[sp_tonghopnhapxuat]
@BEGIN NCHAR(10),
@END NCHAR(10),
@MODE NCHAR
AS
BEGIN
	IF(@MODE = 'C')	--QUYỀN CHI NHÁNH
	BEGIN
		SELECT NGAY= ISNULL(TOHOPXUAT.NGAY, TOHOPNHAP.NGAY), TONGTIENNHAP=ISNULL(TOHOPNHAP.TONGTIEN,0),
				TONGTIENXUAT=ISNULL(TOHOPXUAT.TONGTIEN,0), TYLENHAP=(ISNULL(TOHOPNHAP.TONGTIEN,0)/(ISNULL(TOHOPNHAP.TONGTIEN,0)+ISNULL(TOHOPXUAT.TONGTIEN,0))),
				TYLEXUAT=(ISNULL(TOHOPXUAT.TONGTIEN,0)/(ISNULL(TOHOPNHAP.TONGTIEN,0)+ISNULL(TOHOPXUAT.TONGTIEN,0)))
		FROM
		(
			(
				SELECT PXFILTER.NGAY, ISNULL(SUM(CTPX.SOLUONG * CTPX.DONGIA),0) AS 'TONGTIEN'
				FROM (SELECT MAPX, NGAY FROM DBO.PHIEUXUAT WHERE NGAY BETWEEN @BEGIN AND @END) PXFILTER
				INNER JOIN DBO.CTPX CTPX ON CTPX.MAPX = PXFILTER.MAPX
				GROUP BY PXFILTER.NGAY
			) TOHOPXUAT
			 FULL OUTER JOIN
			(
				SELECT PNFILTER.NGAY, ISNULL(SUM(CTPN.SOLUONG * CTPN.DONGIA),0) AS 'TONGTIEN'
				FROM (SELECT MAPN, NGAY FROM DBO.PHIEUNHAP WHERE NGAY BETWEEN @BEGIN AND  @END) PNFILTER
				INNER JOIN DBO.CTPN CTPN ON CTPN.MAPN = PNFILTER.MAPN
				GROUP BY PNFILTER.NGAY
			) TOHOPNHAP
			ON TOHOPXUAT.NGAY = TOHOPNHAP.NGAY
		)
	END
	ELSE
	BEGIN
		SELECT NGAY= ISNULL(TOHOPXUAT.NGAY, TOHOPNHAP.NGAY), TONGTIENNHAP=ISNULL(TOHOPNHAP.TONGTIEN,0),
				TONGTIENXUAT=ISNULL(TOHOPXUAT.TONGTIEN,0), TYLENHAP=(ISNULL(TOHOPNHAP.TONGTIEN,0)/(ISNULL(TOHOPNHAP.TONGTIEN,0)+ISNULL(TOHOPXUAT.TONGTIEN,0))),
				TYLEXUAT=(ISNULL(TOHOPXUAT.TONGTIEN,0)/(ISNULL(TOHOPNHAP.TONGTIEN,0)+ISNULL(TOHOPXUAT.TONGTIEN,0)))
		FROM
		(
			(SELECT PXFILTER.NGAY, ISNULL(SUM(CTPX.SOLUONG * CTPX.DONGIA),0) AS 'TONGTIEN'
			FROM (SELECT MAPX, NGAY FROM LINK0.QLVT_DATHANG.DBO.PHIEUXUAT WHERE NGAY BETWEEN @BEGIN AND @END) PXFILTER
			INNER JOIN LINK0.QLVT_DATHANG.DBO.CTPX CTPX ON CTPX.MAPX = PXFILTER.MAPX
			GROUP BY PXFILTER.NGAY) TOHOPXUAT
			 FULL OUTER JOIN
			(SELECT PNFILTER.NGAY, ISNULL(SUM(CTPN.SOLUONG * CTPN.DONGIA),0) AS 'TONGTIEN'
			FROM (SELECT MAPN, NGAY FROM LINK0.QLVT_DATHANG.DBO.PHIEUNHAP WHERE NGAY BETWEEN @BEGIN AND @END) PNFILTER
			INNER JOIN LINK0.QLVT_DATHANG.DBO.CTPN CTPN ON CTPN.MAPN = PNFILTER.MAPN
			GROUP BY PNFILTER.NGAY) TOHOPNHAP
			ON TOHOPXUAT.NGAY = TOHOPNHAP.NGAY
		)
	END
END
//*******************************************************
CREATE PROCEDURE [dbo].[SP_ThongTinNhanVien] @MANV INT
AS
BEGIN
	SELECT MANV, HO + ' ' + TEN AS HOTEN, FORMAT(NGAYSINH,'dd/MM/yyyy'), DIACHI, LUONG, MACN
	FROM dbo.NhanVien 
	WHERE MANV = @MANV
END
//*********************************
CREATEPROC [dbo].[sp_dsnvcohoadon]
AS
BEGIN
SELECT DISTINCT NV.MANV, NV.HO + ' ' + NV.TEN AS HOTEN
FROM  NHANVIEN AS NV, PHIEUNHAP AS PN  , PHIEUXUAT AS PX
WHERE NV.MANV = PN.MANV OR  NV.MANV = PX.MANV
END
//***************************
CREATEPROC [dbo].[sp_kiemtratontaiuser]
@user NVARCHAR(50)
AS
BEGIN
SELECT NAME FROM SYS.sysusers WHERE NAME= @user
END
//****************************
CREATEPROC [dbo].[sp_vattutrongddh]
@MASODDH NCHAR(8)
AS
BEGIN
SELECT VATTU.MAVT, VATTU.TENVT, VT.SOLUONG
FROM VATTU, (SELECT MAVT, CTDDH.SOLUONG FROM CTDDH,DATHANG  WHERE CTDDH.MASODDH= DATHANG.MASODDH AND DATHANG.MASODDH= @MASODDH) VT
WHERE VATTU.MAVT= VT.MAVT
END 